name: vCenter VM Report

on:
  workflow_dispatch:

jobs:
  fetch-vms:
    name: Generate VM Report from vCenter
    runs-on: [self-hosted, windows]

    env:
      VCENTER_SERVER: ${{ secrets.VCENTER_SERVER }}
      VCENTER_USER:   ${{ secrets.VCENTER_USER }}
      VCENTER_PASS:   ${{ secrets.VCENTER_PASS }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run PowerShell VM list script
        shell: pwsh
        run: |
          $securePass = ConvertTo-SecureString "$env:VCENTER_PASS" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ($env:VCENTER_USER, $securePass)
          .\Thames\vm_list.ps1 -vcenter $env:VCENTER_SERVER -cred $cred

      - name: Upload VM report CSV as artifact
        uses: actions/upload-artifact@v4
        with:
          name: VM_Report
          path: Thames/vm_report.csv
