name: FleetControl Grohe Report

on:
  workflow_dispatch:      # manual trigger
  #schedule:               # scheduled daily at 05:00 UTC
   # - cron: '0 5 * * *'

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests tzdata

      - name: Run FC_Report.py for Grohe (Query 3, current month)
        run: |
          CUR_YEAR=$(date +'%Y')
          CUR_MONTH=$(date +'%-m')
          printf '2\n3\n%s\n%s\n' "$CUR_YEAR" "$CUR_MONTH" \
            | python FleetControl/FC_Report.py

      - name: Upload CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: fleet-report
          path: '*.csv'

      - name: Send Slack message
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "*ðŸ“Š FleetControl Grohe Report generated*\n\nâ€¢ Report: `Grohe_events_${{ env.CUR_YEAR }}_${{ env.CUR_MONTH }}_patch.csv`\nâ€¢ [âž¡ï¸ View & Download CSV from GitHub Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Set current date as environment variables
        run: |
          echo "CUR_YEAR=$(date +'%Y')" >> $GITHUB_ENV
          echo "CUR_MONTH=$(date +'%b' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
