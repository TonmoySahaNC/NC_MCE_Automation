name: FleetControl Query 3 Report

on:
  workflow_dispatch:
  #schedule:
   # - cron: '0 5 * * *'

jobs:
  report:
    runs-on: ubuntu-latest

    env:
      FLOW_URL: ${{ secrets.FLOW_URL }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests tzdata

      - name: Run FC_Report.py for Query 3 (Brother, current month)
        id: csv
        run: |
          CUR_YEAR=$(date +'%Y')
          CUR_MONTH=$(date +'%-m')
          echo "Running for Brother (Customer 1), Query 3..."
          printf '1\n3\n%s\n%s\n' "$CUR_YEAR" "$CUR_MONTH" | python FleetControl/FC_Report.py
          GENERATED=$(ls *_events_${CUR_YEAR}_*.csv | head -n1)
          echo "file=$GENERATED" >> "$GITHUB_OUTPUT"

      - name: Upload CSV to Power Automate Flow
        run: |
          FILE="${{ steps.csv.outputs.file }}"
          echo "Uploading $FILE to Power Automate flow..."

          b64content=$(base64 -w0 "$FILE")
          jq -n --arg filename "$FILE" --arg filecontent "$b64content" \
            '{filename: $filename, filecontent: $filecontent}' > payload.json

          curl -sSL -X POST "$FLOW_URL" \
               -H "Content-Type: application/json" \
               --data @payload.json

          echo "Flow invoked"
        env:
          FLOW_URL: ${{ secrets.FLOW_URL }}
